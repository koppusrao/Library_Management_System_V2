import React, { useEffect, useState } from "react";
import axios from "axios";

function BorrowBook() {
  const [members, setMembers] = useState([]);
  const [books, setBooks] = useState([]);
  const [memberId, setMemberId] = useState("");
  const [bookId, setBookId] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [success, setSuccess] = useState("");

  // ---------- Load Members ----------
  useEffect(() => {
    axios
      .get("http://localhost:3001/members")
      .then((res) => setMembers(res.data || []))
      .catch(() => setError("Failed to load members"));
  }, []);

  // ---------- Load Available Books ----------
  useEffect(() => {
    axios
      .get("http://localhost:3001/available-books")
      .then((res) => setBooks(res.data || []))
      .catch(() => setError("Failed to load books"));
  }, []);

  // ---------- Borrow ----------
  const handleBorrow = async () => {
    setError("");
    setSuccess("");

    if (!memberId) {
      setError("Please select a member");
      return;
    }

    if (!bookId) {
      setError("Please select a book");
      return;
    }

    setLoading(true);

    try {
      await axios.post("http://localhost:3001/borrow", {
        member_id: Number(memberId),
        book_id: Number(bookId)
      });

      setSuccess("Book borrowed successfully");

      // Reset selection
      setBookId("");

      // Refresh available books
      const refreshed = await axios.get("http://localhost:3001/available-books");
      setBooks(refreshed.data || []);
    } catch (err) {
      setError(
        err?.response?.data?.message ||
        "Borrow operation failed"
      );
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{ maxWidth: "420px", margin: "20px auto" }}>
      <h2>Borrow Book</h2>

      {error && <p style={{ color: "red" }}>{error}</p>}
      {success && <p style={{ color: "green" }}>{success}</p>}

      <label>Member</label>
      <select
        value={memberId}
        onChange={(e) => {
          setMemberId(e.target.value);
          setSuccess("");
          setError("");
        }}
        style={{ width: "100%", padding: "8px", marginBottom: "10px" }}
      >
        <option value="">Select Member</option>
        {members.map((m) => (
          <option key={m.id} value={m.id}>
            {m.name} ({m.email})
          </option>
        ))}
      </select>

      <label>Book</label>
      <select
        value={bookId}
        onChange={(e) => {
          setBookId(e.target.value);
          setSuccess("");
          setError("");
        }}
        style={{ width: "100%", padding: "8px", marginBottom: "10px" }}
      >
        <option value="">Select Book</option>
        {books.map((b) => (
          <option key={b.id} value={b.id}>
            {b.title}
          </option>
        ))}
      </select>

      <button
        onClick={handleBorrow}
        disabled={loading}
        style={{
          width: "100%",
          padding: "10px",
          backgroundColor: "#2196F3",
          color: "white",
          border: "none",
          fontSize: "16px"
        }}
      >
        {loading ? "Processing..." : "Borrow"}
      </button>
    </div>
  );
}

export default BorrowBook;